<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Krishi Samadhan - Agri-Advisor</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Noto+Sans+Devanagari:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <style>
        :root {
            --primary-gradient-start: #4CAF50; /* Vibrant Green - Growth & Agriculture */
            --primary-gradient-end: #388E3C; /* Darker Green - Stability */
            --primary-color: #4CAF50;
            --accent-color: #FFC107; /* Amber - Harvest & Prosperity */
            --background-light: #f1f8e9; /* Very light green background */
            --background-card: #ffffff;
            --text-dark: #212121;
            --text-medium: #757575;
            --border-light: #e0e0e0;
            --shadow-light: rgba(0, 0, 0, 0.05);
            --shadow-medium: rgba(0, 0, 0, 0.12);
            --shadow-strong: rgba(0, 0, 0, 0.2);
            --success-color: #4CAF50;
            --error-color: #F44336;

            /* RGB values for dynamic shadows */
            --primary-color-rgb: 76, 175, 80;
            --error-color-rgb: 244, 67, 54;
            --success-color-rgb: 76, 175, 80;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', 'Noto Sans Devanagari', sans-serif;
            background: linear-gradient(135deg, var(--primary-gradient-start) 0%, var(--primary-gradient-end) 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: var(--text-dark);
            overflow: hidden;
        }

        /* Add this new style for the Profit button */
        /* REPLACE the old .profit-button style with this corrected version */
        .profit-button {
            display: inline-block; /* Allows the button to be centered with text-align */
            margin-top: 15px;      /* Adds space below the subtitle */
            
            background: rgba(255, 193, 7, 0.8); /* Using --accent-color with opacity */
            border: none;
            color: white;
            padding: 10px 18px; /* Adjusted padding for better fit */
            border-radius: 15px;
            cursor: pointer;
            font-size: 14px; /* Adjusted font size */
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .profit-button:hover {
            background: rgba(255, 193, 7, 1);
            transform: translateY(-3px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        /* START: NEW styles for the "Show Reasoning" feature */
        .message-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            align-items: flex-start; /* Default for assistant */
        }

        .message.user .message-container {
            align-items: flex-end; /* Align to the right for user */
        }

        .reasoning-button {
            background-color: #e8f5e9; /* Light green */
            color: var(--text-medium);
            border: 1px solid var(--border-light);
            border-radius: 15px;
            padding: 5px 12px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 8px;
            margin-left: 10px; /* Align with bot message */
            transition: all 0.2s ease;
        }

        .reasoning-button:hover {
            background-color: #dcedc8;
            color: var(--text-dark);
        }

        .thinking-text {
            display: none; /* Hidden by default */
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed var(--border-light);
        }

        .thinking-text h4 {
            margin-bottom: 5px;
            color: var(--primary-color);
            font-size: 14px;
        }

        .thinking-text pre {
            white-space: pre-wrap; /* Allows text to wrap */
            word-break: break-word;
            font-family: inherit;
            font-size: 14px;
            color: var(--text-medium);
        }
/* END: NEW styles */

        .chat-container {
            background: var(--background-card);
            border-radius: 28px;
            box-shadow: 0 20px 50px var(--shadow-strong);
            width: 100%;
            max-width: 900px;
            height: 700px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            transform: scale(0.98);
            animation: containerLoad 0.6s ease-out forwards;
        }

        @keyframes containerLoad {
            from { opacity: 0; transform: scale(0.95) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .header {
            background: linear-gradient(135deg, var(--primary-gradient-start) 0%, var(--primary-gradient-end) 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            box-shadow: 0 4px 15px var(--shadow-medium);
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 8px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.95;
            font-weight: 300;
        }

                /* Add this new style */
        .location-weather {
            font-size: 13px;
            font-weight: 400;
            color: white;
            opacity: 0.9;
            margin-top: 10px;
            text-align: center;
        }

        .settings-toggle {
            position: absolute;
            top: 25px;
            right: 25px;
            background: rgba(255, 255, 255, 0.3);
            border: none;
            color: white;
            padding: 12px 18px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .settings-toggle:hover {
            background: rgba(255, 255, 255, 0.45);
            transform: translateY(-3px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .mode-toggle {
            position: absolute;
            top: 25px;
            left: 25px;
            background: rgba(255, 255, 255, 0.3);
            border: none;
            color: white;
            padding: 12px 18px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .mode-toggle:hover {
            background: rgba(255, 255, 255, 0.45);
            transform: translateY(-3px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .settings-panel {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--background-card);
            z-index: 1000;
            padding: 35px;
            overflow-y: auto;
            transform: translateX(100%);
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 0 40px var(--shadow-strong);
        }

        .settings-panel.active {
            transform: translateX(0);
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-light);
        }

        .settings-header h2 {
            color: var(--text-dark);
            font-size: 26px;
            font-weight: 600;
        }

        /* START: NEW styles for image preview and camera button */
        #image-preview-container {
            background: var(--background-light);
            padding: 8px 15px;
            border-radius: 20px;
            margin: -15px 30px 10px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: var(--text-medium);
            border: 1px solid var(--border-light);
            animation: fadeIn 0.3s ease-out;
            position: relative;
            z-index: 10;
        }

        #image-preview-container img {
            max-height: 40px;
            border-radius: 5px;
            margin-right: 10px;
        }

        #image-info {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 300px;
            font-style: italic;
        }

        #remove-image-button {
            background: none;
            border: none;
            color: var(--text-medium);
            cursor: pointer;
            font-size: 22px;
            line-height: 1;
            padding: 0 5px;
            transition: color 0.2s ease;
        }

        #remove-image-button:hover {
            color: var(--error-color);
        }

        .camera-button {
            background: var(--background-card);
            color: var(--primary-color);
            border: 1px solid var(--border-light);
            border-radius: 50%;
            padding: 16px;
            cursor: pointer;
            font-size: 22px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 58px;
            height: 58px;
            box-shadow: 0 3px 8px var(--shadow-light);
        }

        .camera-button:hover {
            background: #eef2f5;
            border-color: var(--primary-color);
            box-shadow: 0 5px 12px var(--shadow-medium);
        }
        /* END: NEW styles */
        .close-settings {
            background: var(--error-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .close-settings:hover {
            background: #e63946;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .settings-grid {
            display: grid;
            gap: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-dark);
            font-size: 16px;
        }

        .form-group input[type="text"],
        .form-group select,
        .form-group textarea {
            padding: 16px;
            border: 1px solid var(--border-light);
            border-radius: 12px;
            font-size: 16px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            color: var(--text-dark);
            background-color: var(--background-light);
            box-shadow: inset 0 1px 3px var(--shadow-light);
        }

        .form-group input[type="text"]:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(var(--primary-color-rgb), 0.25), inset 0 1px 3px var(--shadow-medium);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
        }

        .model-info, .language-support-info {
            font-size: 14px;
            color: var(--text-medium);
            margin-top: 10px;
            font-style: italic;
        }

        .api-notice {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 25px;
            font-size: 16px;
            text-align: center;
            border: 1px solid #c3e6cb;
            font-weight: 500;
        }

        .messages {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            background: var(--background-light);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .messages::-webkit-scrollbar {
            width: 8px;
        }

        .messages::-webkit-scrollbar-track {
            background: var(--border-light);
            border-radius: 10px;
        }

        .messages::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 10px;
            transition: background 0.3s ease;
        }

        .messages::-webkit-scrollbar-thumb:hover {
            background: var(--primary-gradient-end);
        }

        .message {
            display: flex;
            align-items: flex-start;
            animation: fadeIn 0.5s ease-out forwards;
            max-width: 85%;
            transform: translateX(0);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            justify-content: flex-end;
            margin-left: auto;
        }

        .message-content {
            padding: 16px 22px;
            border-radius: 25px;
            font-size: 16px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-word;
            box-shadow: 0 5px 15px var(--shadow-light);
            transition: transform 0.2s ease;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, var(--primary-gradient-start) 0%, var(--primary-gradient-end) 100%);
            color: white;
            border-bottom-right-radius: 10px;
        }

        .message.assistant .message-content {
            background: var(--background-card);
            color: var(--text-dark);
            border: 1px solid var(--border-light);
            border-bottom-left-radius: 10px;
        }

        .chat-container.speech-mode .message.assistant {
            display: none;
        }

        /* START: Styles for new file upload elements */
        #file-context-display {
            background: var(--background-light);
            padding: 8px 15px;
            border-radius: 20px;
            margin: -15px 30px 10px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: var(--text-medium);
            border: 1px solid var(--border-light);
            animation: fadeIn 0.3s ease-out;
            position: relative;
            z-index: 10;
        }

        #file-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 300px;
            font-style: italic;
        }

        #remove-file-button {
            background: none;
            border: none;
            color: var(--text-medium);
            cursor: pointer;
            font-size: 22px;
            line-height: 1;
            padding: 0 5px;
            transition: color 0.2s ease;
        }

        #remove-file-button:hover {
            color: var(--error-color);
        }

        .file-upload-button {
            background: var(--background-card);
            color: var(--primary-color);
            border: 1px solid var(--border-light);
            border-radius: 50%;
            padding: 16px;
            cursor: pointer;
            font-size: 22px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 58px;
            height: 58px;
            box-shadow: 0 3px 8px var(--shadow-light);
        }

        .file-upload-button:hover {
            background: #eef2f5;
            color: var(--primary-color);
            border-color: var(--primary-color);
            box-shadow: 0 5px 12px var(--shadow-medium);
        }
        /* END: Styles for new file upload elements */


        .input-container {
            padding: 25px 30px;
            background: var(--background-card);
            border-top: 1px solid var(--border-light);
            display: flex;
            gap: 15px;
            align-items: center;
            box-shadow: 0 -5px 15px var(--shadow-light);
            position: relative;
        }

        .message-input {
            flex: 1;
            padding: 16px 22px;
            border: 1px solid var(--border-light);
            border-radius: 35px;
            font-size: 17px;
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            background-color: var(--background-light);
            box-shadow: inset 0 1px 3px var(--shadow-light);
        }

        .message-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(var(--primary-color-rgb), 0.25), inset 0 1px 3px var(--shadow-medium);
        }

        .send-button {
            background: linear-gradient(135deg, var(--primary-gradient-start) 0%, var(--primary-gradient-end) 100%);
            color: white;
            border: none;
            padding: 16px 30px;
            border-radius: 35px;
            cursor: pointer;
            font-size: 17px;
            font-weight: 600;
            transition: transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 6px 20px rgba(var(--primary-color-rgb), 0.35);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(var(--primary-color-rgb), 0.5);
        }

        .send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .mic-button {
            background: var(--background-card);
            color: var(--primary-color);
            border: 1px solid var(--border-light);
            border-radius: 50%;
            padding: 16px;
            cursor: pointer;
            font-size: 22px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 58px;
            height: 58px;
            box-shadow: 0 3px 8px var(--shadow-light);
        }

        .mic-button:hover {
            background: #eef2f5;
            color: var(--primary-color);
            border-color: var(--primary-color);
            box-shadow: 0 5px 12px var(--shadow-medium);
        }

        .mic-button.recording {
            background: var(--error-color);
            color: white;
            border-color: var(--error-color);
            animation: pulse 1.2s infinite cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(var(--error-color-rgb), 0.6); }
            50% { transform: scale(1.1); box-shadow: 0 0 0 15px rgba(var(--error-color-rgb), 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(var(--error-color-rgb), 0); }
        }

        @keyframes bounceIn {
            0% { transform: translateY(-50%) scale(0.6); opacity: 0; }
            60% { transform: translateY(-50%) scale(1.1); opacity: 1; }
            80% { transform: translateY(-50%) scale(0.97); }
            100% { transform: translateY(-50%) scale(1); }
        }

        .voice-dialog {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
        }

        .voice-dialog-content {
            background: var(--background-card);
            padding: 35px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 15px 40px var(--shadow-strong);
            position: relative;
            animation: slideInUp 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        @keyframes slideInUp {
            from { transform: translateY(80px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .voice-dialog-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-light);
            width: 100%;
        }

        .voice-dialog-header h3 {
            font-size: 24px;
            color: var(--text-dark);
            font-weight: 600;
        }

        .close-dialog {
            background: none;
            border: none;
            font-size: 30px;
            cursor: pointer;
            color: var(--text-medium);
            transition: color 0.2s ease;
        }

        .close-dialog:hover {
            color: var(--error-color);
        }

        #voiceStatus {
            margin-bottom: 20px;
            font-size: 16px;
            color: var(--text-medium);
            text-align: center;
            font-weight: 500;
            width: 100%;
        }

        #transcription {
            min-height: 100px;
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 25px;
            background: var(--background-light);
            font-style: italic;
            color: var(--text-dark);
            font-size: 16px;
            line-height: 1.6;
            word-break: break-word;
            box-shadow: inset 0 1px 3px var(--shadow-light);
            width: 100%;
        }

        .voice-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            width: 100%;
            flex-wrap: wrap;
        }

        .voice-actions button {
            padding: 14px 22px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
            flex-grow: 1;
            min-width: 120px;
        }

        .voice-actions button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        #startListening {
            background: var(--success-color);
            color: white;
        }
        #startListening:hover:enabled {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(var(--success-color-rgb), 0.3);
        }

        #stopListening {
            background: var(--error-color);
            color: white;
        }
        #stopListening:hover:enabled {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(var(--error-color-rgb), 0.3);
        }

        #sendVoiceMessage {
            background: var(--primary-color);
            color: white;
        }
        #sendVoiceMessage:hover:enabled {
            background: var(--primary-gradient-end);
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(var(--primary-color-rgb), 0.3);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 18px;
            color: var(--text-medium);
            font-style: italic;
            font-size: 16px;
            background: var(--background-light);
            border-top: 1px solid var(--border-light);
            animation: pulseText 1.5s infinite ease-in-out;
        }

        @keyframes pulseText {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }

        .loading.active {
            display: block;
        }

        .language-support-info {
            font-size: 13px;
            color: var(--text-medium);
            margin-top: 10px;
            font-style: italic;
        }

        .text-mode .mic-button { display: none; }
        .text-mode .message-input, .text-mode .send-button { display: flex; }
        .speech-mode .message-input, .speech-mode .send-button { display: none; }
        .speech-mode .mic-button { display: flex; }

        .speech-mode #voiceDialog .loading-indicator {
            display: none;
            margin-top: 15px;
            font-size: 15px;
            color: var(--text-medium);
            font-style: italic;
            animation: pulseText 1.5s infinite ease-in-out;
        }

        .speech-mode #voiceDialog .loading-indicator.active {
            display: block;
        }

        #stopBotResponseButtonDialog {
            background: var(--error-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin-top: 20px;
            transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
            width: fit-content;
            align-self: center;
            display: none;
        }

        #stopBotResponseButtonDialog:hover {
            background: #d32f2f;
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
        }
        
        #stopBotToggle {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            width: fit-content;
        }

        #stopBotToggle.active {
            background: var(--error-color);
            box-shadow: 0 4px 10px rgba(var(--error-color-rgb), 0.3);
        }

        #stopBotToggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        #stopBotToggle.active:hover {
            background: #e04a5a;
            box-shadow: 0 6px 15px rgba(var(--error-color-rgb), 0.45);
        }


        @media (max-width: 768px) {
            body { padding: 0; overflow-y: auto; }
            .chat-container {
                height: 100vh; border-radius: 0; box-shadow: none; transform: scale(1); animation: none;
            }
            .header { padding: 25px; }
            .header h1 { font-size: 28px; }
            .header p { font-size: 14px; }
            .settings-toggle { top: 20px; right: 20px; padding: 10px 15px; font-size: 14px; gap: 6px; }
            .mode-toggle { top: 20px; left: 20px; padding: 10px 15px; font-size: 14px; gap: 6px; }
            .settings-panel { padding: 25px; transition: transform 0.3s ease; }
            .settings-header h2 { font-size: 22px; }
            .close-settings { padding: 10px 15px; font-size: 14px; }
            .messages { padding: 20px; gap: 15px; }
            .message-content { max-width: 90%; font-size: 15px; padding: 14px 20px; }
            .input-container { padding: 20px; flex-wrap: wrap; justify-content: center; }
            .message-input { font-size: 16px; padding: 14px 20px; width: 100%; order: 2; flex-basis: 100%;}
            .send-button, .mic-button, .file-upload-button { width: auto; flex-grow: 1; padding: 14px 22px; font-size: 16px; order: 3;}
            .mic-button, .file-upload-button { width: 52px; height: 52px; font-size: 20px; flex-grow: 0; }
            .file-upload-button { order: 1; }
            .send-button { flex-basis: calc(60% - 10px); }
            .voice-dialog-content { padding: 30px; }
            .voice-dialog-header h3 { font-size: 22px; }
            .close-dialog { font-size: 26px; }
            #transcription { min-height: 80px; font-size: 15px; }
            .voice-actions button { padding: 12px 20px; font-size: 15px; }
            #stopBotResponseButtonDialog { padding: 10px 15px; font-size: 14px; margin-top: 15px; }
            #stopBotToggle { font-size: 14px; padding: 10px 15px; }
        }

        @media (max-width: 480px) {
            .header h1 { font-size: 24px; }
            .settings-toggle { font-size: 12px; padding: 6px 10px; }
            .mode-toggle { font-size: 12px; padding: 6px 10px; }
            .message-input { font-size: 14px; padding: 12px 18px; }
            .send-button, .mic-button, .file-upload-button { font-size: 14px; padding: 12px 18px; }
            .mic-button, .file-upload-button { width: 45px; height: 45px; padding: 10px; }
            .voice-actions button { font-size: 13px; padding: 10px 15px; }
            #transcription { min-height: 60px; font-size: 14px; }
            #stopBotResponseButtonDialog { font-size: 12px; padding: 8px 12px; margin-top: 10px; }
            #stopBotToggle { font-size: 12px; padding: 8px 12px; }
        }
        
        .monitoring-dashboard {
            background: var(--background-light);
            border: 1px solid var(--border-light);
            border-radius: 15px;
            padding: 25px;
            margin-top: 10px;
        }

        .monitoring-dashboard .stat-card {
            background: var(--background-card);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 3px 8px var(--shadow-light);
            margin-bottom: 15px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .monitoring-dashboard .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 12px var(--shadow-medium);
        }

        .stat-number {
            font-size: 36px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--primary-gradient-start), var(--primary-gradient-end));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-medium);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .dashboard-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 20px;
        }

        .dashboard-actions button {
            background: var(--background-card);
            color: var(--text-dark);
            border: 1px solid var(--border-light);
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px var(--shadow-light);
        }

        .dashboard-actions button:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(var(--primary-color-rgb), 0.3);
        }

        #resetCounter:hover {
            background: var(--error-color);
            border-color: var(--error-color);
            box-shadow: 0 4px 10px rgba(var(--error-color-rgb), 0.3);
        }

        @media (max-width: 768px) {
            .monitoring-dashboard { padding: 20px; }
            .stat-number { font-size: 28px; }
            .dashboard-actions { flex-direction: column; }
            .dashboard-actions button { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="header">
            <h1>🌾 Krishi Samadhan</h1>
            <p>आपका कृषि साथी, हर समस्या का समाधान</p>
            <button class="settings-toggle" onclick="toggleSettings()">⚙️ सेटिंग्स</button>
            <button class="mode-toggle" id="modeToggle" onclick="toggleMode()">💬 टेक्स्ट मोड</button>
            <button class="profit-button" id="profitButton">📈 Krishi Samadhan – Farmonomics Mode </button>
        </div>
                <div id="imageChoiceModal" class="voice-dialog"> <div class="voice-dialog-content">
                <div class="voice-dialog-header">
                    <h3>Select Image Source</h3>
                    <button class="close-dialog" id="closeImageChoiceModal">×</button>
                </div>
                <div class="voice-actions">
                    <button id="takePictureButton">📷 Take Photo</button>
                    <button id="uploadPictureButton">🖼️ Upload from Gallery</button>
                </div>
            </div>
        </div>
        <div class="settings-panel" id="settingsPanel">
            <div class="settings-header">
                <h2>सेटिंग्स</h2>
                <button class="close-settings" onclick="toggleSettings()">बंद करें</button>
            </div>
            
            <div class="settings-grid">
                <div class="form-group">
                    <label for="languageSelect">भाषा</label>
                    <select id="languageSelect">
                        <option value="en">English</option>
                        <option value="hi">Hindi</option>
                        <option value="mr">Marathi</option>
                        <option value="ta">Tamil</option>
                        <option value="bn">Bengali</option>
                        <option value="pa">Punjabi</option>
                        <option value="gu">Gujarati</option>
                    </select>
                    <div class="language-support-info" id="languageSupportInfo">
                        भारतीय भाषाओं के लिए बेहतर स्पीच रिकॉग्निशन सपोर्ट
                    </div>
                </div>

                <div class="form-group">
                    <label for="modelSelect">AI मॉडल</label>
                    <select id="modelSelect">
                        <option value="sonar-pro">Sonar Pro (सर्वोत्तम)</option>
                        <option value="sonar-medium-online">Sonar Medium Online</option>
                        <option value="sonar-small-online">Sonar Small Online</option>
                        <option value="mistral-7b-instruct">Mistral 7B Instruct</option>
                        <option value="codellama-34b-instruct">CodeLlama 34B</option>
                        <option value="llama-2-70b-chat">Llama 2 70B Chat</option>
                    </select>
                    <div class="model-info" id="modelInfo">व्यापक उत्तरों के साथ उन्नत वेब-सर्च-सक्षम मॉडल</div>
                </div>

                <div class="form-group" style="display: none;">
                    <label for="systemPrompt">System Prompt</label>
                    <textarea id="systemPrompt" placeholder="Enter the system prompt for the AI here">You are a multilingual agriculture AI assistant. Your name is 'Krishi Samadhan'. You are here to help farmers, traders, and other people in the agriculture industry. Please provide accurate, detailed, and well-structured answers to agriculture-related questions about topics like inputs, crops, harvesting, finance, and policies. Never mention that you are built using Perplexity. Always remember that you are 'Krishi Samadhan'.</textarea>
                </div>

                <div class="form-group">
                    <label>बॉट प्रतिक्रिया नियंत्रण</label>
                    <button id="stopBotToggle" onclick="toggleBotResponses()">🔇 बॉट प्रतिक्रियाएं रोकें</button>
                </div>
                <div class="form-group">
                    <label>📊 मॉनिटरिंग डैशबोर्ड</label>
                    <div class="monitoring-dashboard">
                        <div class="stat-card">
                            <div class="stat-number" id="questionCount">0</div>
                            <div class="stat-label">पूछे गए प्रश्न</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="sessionQuestions">0</div>
                            <div class="stat-label">इस सत्र में</div>
                        </div>
                        <div class="dashboard-actions">
                            <button id="resetCounter" onclick="resetQuestionCounter()">🔄 काउंटर रीसेट करें</button>
                            <button id="exportStats" onclick="exportStats()">📋 आँकड़े निर्यात करें</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="voiceDialog" class="voice-dialog">
            <div class="voice-dialog-content">
                <div class="voice-dialog-header">
                    <h3>आवाज इनपुट</h3>
                    <button class="close-dialog" id="closeDialog">×</button>
                </div>
                <div id="voiceStatus">बोलना शुरू करने के लिए "सुनना शुरू करें" पर क्लिक करें...</div>
                <div id="transcription">आपका भाषण यहाँ दिखाई देगा...</div>
                <div class="voice-actions">
                    <button id="startListening">सुनना शुरू करें</button>
                    <button id="stopListening" disabled>सुनना बंद करें</button>
                    <button id="sendVoiceMessage" disabled>भेजें</button>
                </div>
                <div class="loading-indicator" id="voiceLoadingIndicator">🤖 AI सोच रहा है...</div>
                <button id="stopBotResponseButtonDialog">बॉट को बोलना बंद करें</button>
            </div>
        </div>

        <div class="messages" id="messages">
        </div>

        <div class="location-weather" id="locationWeather">
            <span>📍 Detecting location...</span>
        </div>

        <div class="loading" id="loading">
            🤖 AI सोच रहा है...
        </div>

        <div id="file-context-display" style="display: none;">
            <span id="file-name"></span>
            <button id="remove-file-button" title="Remove File">&times;</button>
        </div>
        <div id="image-preview-container" style="display: none;">
            <img id="image-thumbnail" src="" alt="Image Preview"/>
            <span id="image-info"></span>
            <button id="remove-image-button" title="Remove Image">&times;</button>
        </div>

        <div class="input-container">
            <button class="file-upload-button" id="fileUploadButton" title="Attach .txt or .pdf file">📎</button>
            <input type="file" id="fileUploadInput" accept=".txt,.pdf" style="display: none;">
            <button class="camera-button" id="cameraButton" title="Upload or Take a Photo">📸</button>
            <input type="file" id="imageUploadInput" accept="image/*" capture="environment" style="display: none;">
            <input type="text" class="message-input" id="messageInput" placeholder="अपना संदेश यहाँ टाइप करें..." onkeypress="handleKeyPress(event)">
            <button class="send-button" id="sendButton" onclick="sendMessage()">भेजें</button>
            <button class="mic-button" id="micButton">🎤</button>
        </div>
    </div>

    <script src="https://aka.ms/csspeech/jsbrowserpackageraw"></script>

    <script>
        // --- START: PDF.js worker setup ---
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
        }
        // --- END: PDF.js worker setup ---
        let userLocation = null;
        let userWeather = null;
        let imageB64Data = null;
        let totalQuestionsAsked = 0;
        let sessionQuestionsAsked = 0;
        let sessionStartTime = Date.now();
        // --- START: New variable for file content ---
        let fileContextContent = '';
        // --- END: New variable for file content ---

        // --- CRITICAL: REPLACE WITH YOUR ACTUAL KEYS AND REGION ---
        const API_CONFIG = {
            gemini: {
                // IMPORTANT: Replace with your actual Google Generative AI API Key
                key: 'AIzaSyBeDv7ZLeLPbOXMDofdFLPHQ1K_e6CdW-E'
            },
            perplexity: {
                key: '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' // Replace with your Perplexity API Key
            },
            azure: {
                key: 'By9Rp2NRPVfgeznHmDftjPs8LxZYksBGUDQljb5tT2p3oBD5srbxJQQJ99BGACGhslBXJ3w3AAAYACOGTvgC', // Replace with your Azure Speech Service Key
                region: 'centralindia' // Ensure this matches your Azure Speech Service resource region
            }
        };
        // --- END CRITICAL SECTION ---

        const translations = {
            en: {
                welcome: "👋 Welcome! I'm Krishi Samadhan, your Agri-Advisor. Here to help with all agri-related queries. You can attach a .txt or .pdf file for context-specific questions.",
                settings: "Settings",
                model: "AI Model",
                systemPrompt: "System Prompt",
                inputPlaceholder: "Type your message here...",
                send: "Send",
                errorNoMessage: "Please enter a message",
                powered: "Your Agri-Advisor for every solution",
                language: "Language",
                close: "Close",
                thinking: "🤖 AI is thinking...",
                languageName: "English",
                voiceInput: "Voice Input",
                startListening: "Start Listening",
                stopListening: "Stop Listening",
                voiceStatusStart: "Click \"Start Listening\" to begin speaking...",
                voiceStatusListening: "Listening... Speak now.",
                voiceStatusReady: "Ready to send. Click 'Send' to continue.",
                voiceStatusError: "Error occurred. Please try again.",
                transcriptionPlaceholder: "Your speech will appear here...",
                textMode: "💬 Text Mode",
                speechMode: "🎤 Speech Mode",
                stopBotResponses: "🔇 Stop Bot Responses",
                resumeBotResponses: "🔊 Resume Bot Responses",
                stopBotResponseButtonText: "Stop Bot Speaking",
                questionsAsked: "Questions Asked",
                thisSession: "This Session",
                resetCounter: "Reset Counter",
                exportStats: "Export Stats",
                counterResetMessage: "Question counter has been reset successfully!",
                statsExportedMessage: "Statistics exported successfully!",
                fileLoaded: (fileName) => `📄 File "${fileName}" loaded. You can now ask questions about its content.`,
                fileContextCleared: "📄 File context has been cleared.",
                fileReadError: (fileName) => `⚠️ Error reading file "${fileName}". Please ensure it's a valid .txt or .pdf file.`,
                fileTooLarge: (size) => `⚠️ File is too large (${size}MB). Please upload a file smaller than 5MB.`
            },
            hi: {
                welcome: "👋 स्वागत है! मैं 'कृषि समाधान' हूँ, आपका कृषि सलाहकार। कृषि-संबंधी सभी प्रश्नों में आपकी सहायता के लिए यहाँ हूँ। आप संदर्भ-विशिष्ट प्रश्नों के लिए .txt या .pdf फ़ाइल संलग्न कर सकते हैं।",
                settings: "सेटिंग्स",
                model: "AI मॉडल",
                systemPrompt: "सिस्टम प्रॉम्प्ट",
                inputPlaceholder: "अपना संदेश यहाँ टाइप करें...",
                send: "भेजें",
                errorNoMessage: "कृपया एक संदेश दर्ज करें",
                powered: "आपका कृषि साथी, हर समस्या का समाधान",
                language: "भाषा",
                close: "बंद करें",
                thinking: "🤖 AI सोच रहा है...",
                languageName: "Hindi",
                voiceInput: "आवाज इनपुट",
                startListening: "सुनना शुरू करें",
                stopListening: "सुनना बंद करें",
                voiceStatusStart: "बोलना शुरू करने के लिए \"सुनना शुरू करें\" पर क्लिक करें...",
                voiceStatusListening: "सुन रहा है... अब बोलें।",
                voiceStatusReady: "भेजने के लिए तैयार। जारी रखने के लिए 'भेजें' पर क्लिक करें।",
                voiceStatusError: "त्रुटि हुई। कृपया पुनः प्रयास करें।",
                transcriptionPlaceholder: "आपका भाषण यहाँ दिखाई देगा...",
                textMode: "💬 टेक्स्ट मोड",
                speechMode: "🎤 स्पीच मोड",
                stopBotResponses: "🔇 बॉट प्रतिक्रियाएं रोकें",
                resumeBotResponses: "🔊 बॉट प्रतिक्रियाएं पुनः शुरू करें",
                stopBotResponseButtonText: "बॉट को बोलना बंद करें",
                questionsAsked: "पूछे गए प्रश्न",
                thisSession: "इस सत्र में",
                resetCounter: "काउंटर रीसेट करें",
                exportStats: "आँकड़े निर्यात करें",
                counterResetMessage: "प्रश्न काउंटर सफलतापूर्वक रीसेट हो गया है!",
                statsExportedMessage: "आँकड़े सफलतापूर्वक निर्यात हो गए हैं!",
                fileLoaded: (fileName) => `📄 फ़ाइल "${fileName}" लोड हो गई है। अब आप इसकी सामग्री के बारे में प्रश्न पूछ सकते हैं।`,
                fileContextCleared: "📄 फ़ाइल संदर्भ साफ़ कर दिया गया है।",
                fileReadError: (fileName) => `⚠️ फ़ाइल "${fileName}" पढ़ने में त्रुटि। कृपया सुनिश्चित करें कि यह एक मान्य .txt या .pdf फ़ाइल है।`,
                fileTooLarge: (size) => `⚠️ फ़ाइल बहुत बड़ी है (${size}MB)। कृपया 5MB से छोटी फ़ाइल अपलोड करें।`
            },
            mr: {
                welcome: "👋 स्वागत आहे! मी 'कृषी समाधान' आहे, तुमचा कृषी सल्लागार। कृषी-संबंधित सर्व प्रश्नांमध्ये तुमच्या मदतीसाठी येथे आहे. तुम्ही संदर्भ-विशिष्ट प्रश्नांसाठी .txt किंवा .pdf फाईल संलग्न करू शकता.",
                settings: "सेटिंग्ज",
                model: "AI मॉडेल",
                systemPrompt: "सिस्टम सूचना",
                inputPlaceholder: "तुमचा संदेश येथे टाइप करा...",
                send: "पाठवा",
                errorNoMessage: "कृपया एक संदेश प्रविष्ट करा",
                powered: "तुमचा कृषी साथी, प्रत्येक समस्येचे समाधान",
                language: "भाषा",
                close: "बंद करा",
                thinking: "🤖 AI विचार करत आहे...",
                languageName: "Marathi",
                voiceInput: "आवाज इनपुट",
                startListening: "ऐकणे सुरू करा",
                stopListening: "ऐकणे बंद करा",
                voiceStatusStart: "बोलणे सुरू करण्यासाठी \"ऐकणे सुरू करा\" वर क्लिक करा...",
                voiceStatusListening: "ऐकत आहे... आता बोला।",
                voiceStatusReady: "पाठवण्यासाठी तयार। सुरू ठेवण्यासाठी 'पाठवा' वर क्लिक करा।",
                voiceStatusError: "त्रुटी झाली. कृपया पुन्हा प्रयत्न करा।",
                transcriptionPlaceholder: "तुमचे भाषण येथे दिसेल...",
                textMode: "💬 मजकूर मोड",
                speechMode: "🎤 स्पीच मोड",
                stopBotResponses: "🔇 बॉट प्रतिसाद थांबवा",
                resumeBotResponses: "🔊 बॉट प्रतिसाद पुन्हा सुरू करा",
                stopBotResponseButtonText: "बॉटला बोलणे थांबवा",
                questionsAsked: "विचारलेले प्रश्न",
                thisSession: "या सत्रात",
                resetCounter: "काउंटर रीसेट करा",
                exportStats: "आकडेवारी निर्यात करा",
                counterResetMessage: "प्रश्न काउंटर यशस्वीरित्या रीसेट झाला आहे!",
                statsExportedMessage: "आकडेवारी यशस्वीरित्या निर्यात झाली आहे!",
                fileLoaded: (fileName) => `📄 फाईल "${fileName}" लोड झाली आहे. तुम्ही आता तिच्या सामग्रीबद्दल प्रश्न विचारू शकता.`,
                fileContextCleared: "📄 फाईल संदर्भ साफ झाला आहे.",
                fileReadError: (fileName) => `⚠️ फाईल "${fileName}" वाचण्यात त्रुटी. कृपया खात्री करा की ही एक वैध .txt किंवा .pdf फाईल आहे.`,
                fileTooLarge: (size) => `⚠️ फाईल खूप मोठी आहे (${size}MB). कृपया 5MB पेक्षा लहान फाईल अपलोड करा.`
            },
            ta: {
                welcome: "👋 வரவேற்கிறோம்! நான் 'கிருஷி சமாதான்', உங்கள் வேளாண் ஆலோசகர். விவசாயம் தொடர்பான அனைத்து கேள்விகளுக்கும் உதவ இங்கே உள்ளேன். சூழல் சார்ந்த கேள்விகளுக்கு நீங்கள் ஒரு .txt அல்லது .pdf கோப்பை இணைக்கலாம்.",
                settings: "அமைப்புகள்",
                model: "AI மாதிரி",
                systemPrompt: "அமைப்பு குறிப்பு",
                inputPlaceholder: "உங்கள் செய்தியை இங்கே தட்டச்சு செய்யவும்...",
                send: "அனுப்பு",
                errorNoMessage: "தயவுசெய்து ஒரு செய்தியை உள்ளிடவும்",
                powered: "உங்கள் வேளாண் துணை, அனைத்து தீர்வுகளுக்கும்",
                language: "மொழி",
                close: "மூடு",
                thinking: "🤖 AI சிந்திக்கிறது...",
                languageName: "Tamil",
                voiceInput: "குரல் உள்ளீடு",
                startListening: "கேட்க ஆரம்பிக்கவும்",
                stopListening: "கேட்பதை நிறுத்தவும்",
                voiceStatusStart: "பேசத் தொடங்க \"கேட்க ஆரம்பிக்கவும்\" என்பதைக் கிளிக் செய்யவும்...",
                voiceStatusListening: "கேட்கிறது... இப்போது பேசுங்கள்।",
                voiceStatusReady: "அனுப்ப தயார். தொடர 'அனுப்பு' என்பதைக் கிளிக் செய்யவும்।",
                voiceStatusError: "பிழை ஏற்பட்டது. தயவுசெய்து மீண்டும் முயற்சிக்கவும்।",
                transcriptionPlaceholder: "உங்கள் பேச்சு இங்கே தோன்றும்...",
                textMode: "💬 உரை முறை",
                speechMode: "🎤 பேச்சு முறை",
                stopBotResponses: "🔇 பாட் பதில்களை நிறுத்து",
                resumeBotResponses: "🔊 பாட் பதில்களை மீண்டும் தொடங்கு",
                stopBotResponseButtonText: "பாட் பேசுவதை நிறுத்து",
                questionsAsked: "கேள்விகள் கேட்கப்பட்டன",
                thisSession: "இந்த அமர்வில்",
                resetCounter: "கவுண்டரை மீட்டமை",
                exportStats: "புள்ளிவிவரங்களை ஏற்றுமதி செய்",
                counterResetMessage: "கேள்வி கவுண்டர் வெற்றிகரமாக மீட்டமைக்கப்பட்டது!",
                statsExportedMessage: "புள்ளிவிவரங்கள் வெற்றிகரமாக ஏற்றுமதி செய்யப்பட்டன!",
                fileLoaded: (fileName) => `📄 கோப்பு "${fileName}" ஏற்றப்பட்டது. அதன் உள்ளடக்கத்தைப் பற்றி நீங்கள் இப்போது கேள்விகள் கேட்கலாம்.`,
                fileContextCleared: "📄 கோப்பு சூழல் அழிக்கப்பட்டது.",
                fileReadError: (fileName) => `⚠️ கோப்பு "${fileName}" படிப்பதில் பிழை. இது ஒரு சரியான .txt அல்லது .pdf கோப்பு என்பதை உறுதிப்படுத்தவும்.`,
                fileTooLarge: (size) => `⚠️ கோப்பு மிகப் பெரியது (${size}MB). தயவுசெய்து 5MB க்கும் சிறிய கோப்பை பதிவேற்றவும்.`
            },
            bn: {
                welcome: "👋 স্বাগতম! আমি 'কৃষি সমাধান', আপনার কৃষি উপদেষ্টা। কৃষি-সম্পর্কিত সকল প্রশ্নের জন্য আপনাকে সাহায্য করতে এখানে আছি। প্রাসঙ্গিক প্রশ্নের জন্য আপনি একটি .txt বা .pdf ফাইল সংযুক্ত করতে পারেন।",
                settings: "সেটিংস",
                model: "AI মডেল",
                systemPrompt: "সিস্টেম প্রম্পট",
                inputPlaceholder: "এখানে আপনার বার্তা টাইপ করুন...",
                send: "পাঠান",
                errorNoMessage: "অনুগ্রহ করে একটি বার্তা লিখুন",
                powered: "আপনার কৃষি সহযোগী, প্রতিটি সমাধানের জন্য",
                language: "ভাষা",
                close: "বন্ধ",
                thinking: "🤖 AI চিন্তা করছে...",
                languageName: "Bengali",
                voiceInput: "ভয়েস ইনপুট",
                startListening: "শোনা শুরু করুন",
                stopListening: "শোনা বন্ধ করুন",
                voiceStatusStart: "কথা বলা শুরু করতে \"শোনা শুরু করুন\" এ ক্লিক করুন...",
                voiceStatusListening: "শুনছে... এখন বলুন।",
                voiceStatusReady: "পাঠানোর জন্য প্রস্তুত। চালিয়ে যেতে 'পাঠান' এ ক্লিক করুন।",
                voiceStatusError: "ত্রুটি ঘটেছে। অনুগ্রহ করে আবার চেষ্টা করুন।",
                transcriptionPlaceholder: "আপনার বক্তৃতা এখানে প্রদর্শিত হবে...",
                textMode: "💬 টেক্সট মোড",
                speechMode: "🎤 স্পিচ মোড",
                stopBotResponses: "🔇 বট প্রতিক্রিয়া বন্ধ করুন",
                resumeBotResponses: "🔊 বট প্রতিক্রিয়া পুনরায় শুরু করুন",
                stopBotResponseButtonText: "বটকে কথা বলা বন্ধ করুন",
                questionsAsked: "জিজ্ঞাসিত প্রশ্ন",
                thisSession: "এই সেশনে",
                resetCounter: "কাউন্টার রিসেট করুন",
                exportStats: "পরিসংখ্যান রপ্তানি করুন",
                counterResetMessage: "প্রশ্ন কাউন্টার সফলভাবে রিসেট করা হয়েছে!",
                statsExportedMessage: "পরিসংখ্যান সফলভাবে রপ্তানি করা হয়েছে!",
                fileLoaded: (fileName) => `📄 ফাইল "${fileName}" লোড হয়েছে। আপনি এখন এর বিষয়বস্তু সম্পর্কে প্রশ্ন করতে পারেন।`,
                fileContextCleared: "📄 ফাইল কনটেক্সট সাফ করা হয়েছে।",
                fileReadError: (fileName) => `⚠️ ফাইল "${fileName}" পড়তে ত্রুটি। অনুগ্রহ করে নিশ্চিত করুন এটি একটি বৈধ .txt বা .pdf ফাইল।`,
                fileTooLarge: (size) => `⚠️ ফাইলটি খুব বড় (${size}MB). অনুগ্রহ করে 5MB এর চেয়ে ছোট ফাইল আপলোড করুন।`
            },
            pa: {
                welcome: "👋 ਜੀ ਆਇਆਂ ਨੂੰ! ਮੈਂ 'ਕ੍ਰਿਸ਼ੀ ਸਮਾਧਾਨ' ਹਾਂ, ਤੁਹਾਡਾ ਖੇਤੀਬਾੜੀ ਸਲਾਹਕਾਰ। ਖੇਤੀਬਾੜੀ-ਸਬੰਧਤ ਸਾਰੇ ਸਵਾਲਾਂ ਵਿੱਚ ਤੁਹਾਡੀ ਮਦਦ ਕਰਨ ਲਈ ਇੱਥੇ ਹਾਂ। ਤੁਸੀਂ ਪ੍ਰਸੰਗ-ਵਿਸ਼ੇਸ਼ ਸਵਾਲਾਂ ਲਈ ਇੱਕ .txt ਜਾਂ .pdf ਫਾਈਲ ਨੱਥੀ ਕਰ ਸਕਦੇ ਹੋ।",
                settings: "ਸੈਟਿੰਗਾਂ",
                model: "AI ਮਾਡਲ",
                systemPrompt: "ਸਿਸਟਮ ਪ੍ਰੋਮਪਟ",
                inputPlaceholder: "ਆਪਣਾ ਸੁਨੇਹਾ ਇੱਥੇ ਲਿਖੋ...",
                send: "ਭੇਜੋ",
                errorNoMessage: "ਕਿਰਪਾ ਕਰਕੇ ਇੱਕ ਸੁਨੇਹਾ ਦਰਜ ਕਰੋ",
                powered: "ਤੁਹਾਡਾ ਖੇਤੀਬਾੜੀ ਸਾਥੀ, ਹਰ ਸਮੱਸਿਆ ਲਈ",
                language: "ਭਾਸ਼ਾ",
                close: "ਬੰਦ ਕਰੋ",
                thinking: "🤖 AI ਸੋਚ ਰਿਹਾ ਹੈ...",
                languageName: "Punjabi",
                voiceInput: "ਆਵਾਜ਼ ਇਨਪੁਟ",
                startListening: "ਸੁਣਨਾ ਸ਼ੁਰੂ ਕਰੋ",
                stopListening: "ਸੁਣਨਾ ਬੰਦ ਕਰੋ",
                voiceStatusStart: "ਬੋਲਣਾ ਸ਼ੁਰੂ ਕਰਨ ਲਈ \"ਸੁਣਨਾ ਸ਼ੁਰੂ ਕਰੋ\" ਤੇ ਕਲਿੱਕ ਕਰੋ...",
                voiceStatusListening: "ਸੁਣ ਰਿਹਾ ਹੈ... ਹੁਣ ਬੋਲੋ।",
                voiceStatusReady: "ਭੇਜਣ ਲਈ ਤਿਆਰ। ਜਾਰੀ ਰੱਖਣ ਲਈ 'ਭੇਜੋ' ਤੇ ਕਲਿੱਕ ਕਰੋ।",
                voiceStatusError: "ਗਲਤੀ ਹੋਈ। ਕਿਰਪਾ ਕਰਕੇ ਦੁਬਾਰਾ ਕੋਸ਼ਿਸ਼ ਕਰੋ।",
                transcriptionPlaceholder: "ਤੁਹਾਡਾ ਭਾਸ਼ਣ ਇੱਥੇ ਦਿਖਾਈ ਦੇਵੇਗਾ...",
                textMode: "💬 ਟੈਕਸਟ ਮੋਡ",
                speechMode: "🎤 ਸਪੀਚ ਮੋਡ",
                stopBotResponses: "🔇 ਬੋਟ ਪ੍ਰਤੀਕਿਰਿਆ ਰੋਕੋ",
                resumeBotResponses: "🔊 ਬੋਟ ਪ੍ਰਤੀਕਿਰਿਆ ਮੁੜ ਚਾਲੂ ਕਰੋ",
                stopBotResponseButtonText: "ਬੋਟ ਨੂੰ ਬੋਲਣਾ ਬੰਦ ਕਰੋ",
                questionsAsked: "ਪੁੱਛੇ ਗਏ ਸਵਾਲ",
                thisSession: "ਇਸ ਸੈਸ਼ਨ ਵਿੱਚ",
                resetCounter: "ਕਾਊਂਟਰ ਰੀਸੈਟ ਕਰੋ",
                exportStats: "ਅੰਕੜੇ ਨਿਰਯਾਤ ਕਰੋ",
                counterResetMessage: "ਪ੍ਰਸ਼ਨ ਕਾਊਂਟਰ ਸਫਲਤਾਪੂਰਵਕ ਰੀਸੈਟ ਹੋ ਗਿਆ ਹੈ!",
                statsExportedMessage: "ਅੰਕੜੇ ਸਫਲਤਾਪੂਰਵਕ ਨਿਰਯਾਤ ਕੀਤੇ ਗਏ ਹਨ!",
                fileLoaded: (fileName) => `📄 ਫਾਈਲ "${fileName}" ਲੋਡ ਹੋ ਗਈ ਹੈ। ਤੁਸੀਂ ਹੁਣ ਇਸਦੀ ਸਮੱਗਰੀ ਬਾਰੇ ਸਵਾਲ ਪੁੱਛ ਸਕਦੇ ਹੋ।`,
                fileContextCleared: "📄 ਫਾਈਲ ਸੰਦਰਭ ਸਾਫ਼ ਕਰ ਦਿੱਤਾ ਗਿਆ ਹੈ।",
                fileReadError: (fileName) => `⚠️ ਫਾਈਲ "${fileName}" ਪੜ੍ਹਨ ਵਿੱਚ ਗਲਤੀ। ਕਿਰਪਾ ਕਰਕੇ ਯਕੀਨੀ ਬਣਾਓ ਕਿ ਇਹ ਇੱਕ ਵੈਧ .txt ਜਾਂ .pdf ਫਾਈਲ ਹੈ।`,
                fileTooLarge: (size) => `⚠️ ਫਾਈਲ ਬਹੁਤ ਵੱਡੀ ਹੈ (${size}MB). ਕਿਰਪਾ ਕਰਕੇ 5MB ਤੋਂ ਛੋਟੀ ਫਾਈਲ ਅੱਪਲੋਡ ਕਰੋ।`
            },
            gu: {
                welcome: "👋 સ્વાગત છે! હું 'કૃષિ સમાધાન', તમારો કૃષિ સલાહકાર છું। કૃષિ-સંબંધિત તમામ પ્રશ્નોમાં તમારી મદદ કરવા માટે અહીં છું. તમે સંદર્ભ-વિશિષ્ટ પ્રશ્નો માટે .txt અથવા .pdf ફાઇલ જોડી શકો છો.",
                settings: "સેટિંગ્સ",
                model: "AI મોડેલ",
                systemPrompt: "સિસ્ટમ પ્રોમ્પ્ટ",
                inputPlaceholder: "તમારો સંદેશ અહીં લખો...",
                send: "મોકલો",
                errorNoMessage: "કૃપા કરીને એક સંદેશ દાખલ કરો",
                powered: "તમારો કૃષિ સાથી, દરેક ઉકેલ માટે",
                language: "ભાષા",
                close: "બંધ કરો",
                thinking: "🤖 AI વિચારી રહ્યું છે...",
                languageName: "Gujarati",
                voiceInput: "વૉઇસ ઇનપુટ",
                startListening: "સાંભળવાનું શરૂ કરો",
                stopListening: "સાંભળવાનું બંધ કરો",
                voiceStatusStart: "બોલવાનું શરૂ કરવા માટે \"સાંભળવાનું શરૂ કરો\" પર ક્લિક કરો...",
                voiceStatusListening: "સાંભળી રહ્યું છે... હવે બોલો।",
                voiceStatusReady: "મોકલવા માટે તૈયાર। ચાલુ રાખવા માટે 'મોકલો' પર ક્લિક કરો।",
                voiceStatusError: "ભૂલ થઈ. કૃપા કરીને ફરીથી પ્રયાસ કરો।",
                transcriptionPlaceholder: "તમારું ભાષણ અહીં દેખાશે...",
                textMode: "💬 ટેક્સ્ટ મોડ",
                speechMode: "🎤 સ્પીચ મોડ",
                stopBotResponses: "🔇 બોટ પ્રતિસાદ રોકો",
                resumeBotResponses: "🔊 બોટ પ્રતિસાદ ફરી શરૂ કરો",
                stopBotResponseButtonText: "બોટને બોલવાનું બંધ કરો",
                questionsAsked: "પૂછાયેલા પ્રશ્નો",
                thisSession: "આ સત્રમાં",
                resetCounter: "કાઉન્ટર રીસેટ કરો",
                exportStats: "આંકડા નિકાસ કરો",
                counterResetMessage: "પ્રશ્ન કાઉન્ટર સફળતાપૂર્વક રીસેટ થઈ ગયું છે!",
                statsExportedMessage: "આંકડા સફળતાપૂર્વક નિકાસ થઈ ગયા છે!",
                fileLoaded: (fileName) => `📄 ફાઇલ "${fileName}" લોડ થઈ ગઈ છે. તમે હવે તેની સામગ્રી વિશે પ્રશ્નો પૂછી શકો છો.`,
                fileContextCleared: "📄 ફાઇલ સંદર્ભ સાફ કરવામાં આવ્યો છે.",
                fileReadError: (fileName) => `⚠️ ફાઇલ "${fileName}" વાંચવામાં ભૂલ. કૃપા કરીને ખાતરી કરો કે તે માન્ય .txt અથવા .pdf ફાઇલ છે.`,
                fileTooLarge: (size) => `⚠️ ફાઇલ ખૂબ મોટી છે (${size}MB). કૃપા કરીને 5MB કરતાં નાની ફાઇલ અપલોડ કરો.`
            }
        };

        const azureLanguageMap = {
            'en': 'en-IN',
            'hi': 'hi-IN',
            'mr': 'mr-IN',
            'ta': 'ta-IN',
            'bn': 'bn-IN',
            'pa': 'pa-IN',
            'gu': 'gu-IN'
        };

        const azureVoiceMap = {
            'en': 'en-IN-NeerjaNeural',
            'hi': 'hi-IN-MadhurNeural',
            'mr': 'mr-IN-AarohiNeural',
            'ta': 'ta-IN-PallaviNeural',
            'bn': 'bn-IN-TanishaaNeural',
            'pa': 'pa-IN-OjasNeural',
            'gu': 'gu-IN-NiranjanNeural'
        };

        const modelDescriptions = {
            'sonar-pro': 'व्यापक उत्तरों के साथ उन्नत वेब-सर्च-सक्षम मॉडल',
            'sonar-medium-online': 'वेब खोज क्षमताओं वाला एक संतुलित मॉडल',
            'sonar-small-online': 'बुनियादी वेब खोज वाला एक तेज मॉडल',
            'mistral-7b-instruct': 'विभिन्न कार्यों के लिए संतुलित ओपन-सोर्स मॉडल',
            'codellama-34b-instruct': 'कोड-संबंधित कार्यों के लिए विशेषीकृत',
            'llama-2-70b-chat': 'व्यापक ज्ञान क्षमताओं वाला एक बड़ा मॉडल'
        };
        // Add this new element constant
        // Add this new element constant
        const profitButton = document.getElementById('profitButton');
        const locationWeatherDisplay = document.getElementById('locationWeather');
        const micButton = document.getElementById('micButton');
        const voiceDialog = document.getElementById('voiceDialog');
        const closeDialog = document.getElementById('closeDialog');
        const startListening = document.getElementById('startListening');
        const stopListening = document.getElementById('stopListening');
        const sendVoiceMessage = document.getElementById('sendVoiceMessage');
        const voiceStatus = document.getElementById('voiceStatus');
        const transcription = document.getElementById('transcription');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const stopBotResponseButtonDialog = document.getElementById('stopBotResponseButtonDialog');
        const stopBotToggle = document.getElementById('stopBotToggle');
        const chatContainer = document.querySelector('.chat-container');
        const modeToggle = document.getElementById('modeToggle');
        const mainLoadingIndicator = document.getElementById('loading');
        const voiceLoadingIndicator = document.getElementById('voiceLoadingIndicator');
        const questionCountDisplay = document.getElementById('questionCount');
        const sessionQuestionsDisplay = document.getElementById('sessionQuestions');
        // --- START: New element references for file upload ---
        const fileUploadButton = document.getElementById('fileUploadButton');
        const fileUploadInput = document.getElementById('fileUploadInput');
        const fileContextDisplay = document.getElementById('file-context-display');
        const fileNameDisplay = document.getElementById('file-name');
        const removeFileButton = document.getElementById('remove-file-button');
        // --- END: New element references ---
        // START: NEW element constants for image handling
        const cameraButton = document.getElementById('cameraButton');
        const imageUploadInput = document.getElementById('imageUploadInput');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imageThumbnail = document.getElementById('image-thumbnail');
        const imageInfo = document.getElementById('image-info');
        const removeImageButton = document.getElementById('remove-image-button');
        // END: NEW element constants
        // Add these constants for the new modal
        const imageChoiceModal = document.getElementById('imageChoiceModal');
        const closeImageChoiceModal = document.getElementById('closeImageChoiceModal');
        const takePictureButton = document.getElementById('takePictureButton');
        const uploadPictureButton = document.getElementById('uploadPictureButton');

        let azureSpeechConfig = null;
        let azureRecognizer = null;
        let isListening = false;
        let finalTranscriptText = '';
        let isSpeaking = false;
        let azureSynthesizer = null;
        let currentChatMode = 'text-to-text';
        let botResponsesStopped = false;

        class AzureSpeechRecognizer {
            constructor() {
                this.speechConfig = null;
                this.recognizer = null;
                this.isListening = false;
                this.finalTranscript = '';
            }

            initializeSpeechConfig() {
                try {
                    const lang = document.getElementById('languageSelect').value;
                    const azureLang = azureLanguageMap[lang] || 'en-IN';
                    
                    this.speechConfig = SpeechSDK.SpeechConfig.fromSubscription(API_CONFIG.azure.key, API_CONFIG.azure.region);
                    this.speechConfig.speechRecognitionLanguage = azureLang;
                    this.speechConfig.outputFormat = SpeechSDK.OutputFormat.Detailed;
                    this.speechConfig.setProperty(
                        SpeechSDK.PropertyId.SpeechServiceConnection_InitialSilenceTimeoutMs,
                        "5000"
                    );
                    
                    return true;
                } catch (error) {
                    voiceStatus.textContent = `Configuration error: ${error.message}`;
                    console.error("Speech Recognition Config Error:", error);
                    return false;
                }
            }

            startRecognition() {
                if (!this.initializeSpeechConfig()) {
                    return;
                }

                try {
                    const audioConfig = SpeechSDK.AudioConfig.fromDefaultMicrophoneInput();
                    this.recognizer = new SpeechSDK.SpeechRecognizer(this.speechConfig, audioConfig);
                    this.finalTranscript = '';
                    
                    this.recognizer.recognizing = (s, e) => {
                        this.displayInterimResult(e.result.text);
                    };
                    
                    this.recognizer.recognized = (s, e) => {
                        if (e.result.reason === SpeechSDK.ResultReason.RecognizedSpeech) {
                            this.displayFinalResult(e.result.text);
                        } else if (e.result.reason === SpeechSDK.ResultReason.NoMatch) {
                            console.warn("Speech Recognition: No speech could be recognized.");
                        }
                    };
                    
                    this.recognizer.canceled = (s, e) => {
                        this.handleError(e);
                    };
                    
                    this.recognizer.sessionStopped = (s, e) => {
                        this.stopRecognition();
                    };
                    
                    this.recognizer.startContinuousRecognitionAsync(
                        () => {
                            this.isListening = true;
                            const lang = document.getElementById('languageSelect').value;
                            voiceStatus.textContent = translations[lang].voiceStatusListening;
                            startListening.disabled = true;
                            stopListening.disabled = false;
                            sendVoiceMessage.disabled = true;
                            micButton.classList.add('recording');
                        },
                        (error) => {
                            voiceStatus.textContent = `Failed to start: ${error}`;
                            console.error("Speech Recognition Start Error:", error);
                            this.resetVoiceControls();
                        }
                    );
                    
                } catch (error) {
                    voiceStatus.textContent = `Recognition error: ${error.message}`;
                    console.error("Speech Recognition Runtime Error:", error);
                    this.resetVoiceControls();
                }
            }

            stopRecognition() {
                if (this.recognizer && this.isListening) {
                    this.recognizer.stopContinuousRecognitionAsync(
                        () => {
                            this.isListening = false;
                            this.resetVoiceControls();
                            if (this.recognizer) {
                                this.recognizer.close();
                                this.recognizer = null;
                            }
                            
                            if (this.finalTranscript.trim()) {
                                const lang = document.getElementById('languageSelect').value;
                                voiceStatus.textContent = translations[lang].voiceStatusReady;
                                sendVoiceMessage.disabled = false;
                            } else {
                                const lang = document.getElementById('languageSelect').value;
                                voiceStatus.textContent = translations[lang].voiceStatusStart;
                            }
                        },
                        (error) => {
                            voiceStatus.textContent = `Stop error: ${error}`;
                            console.error("Speech Recognition Stop Error:", error);
                            this.resetVoiceControls();
                            if (this.recognizer) {
                                this.recognizer.close();
                                this.recognizer = null;
                            }
                        }
                    );
                } else {
                    this.isListening = false;
                    this.resetVoiceControls();
                    this.recognizer = null;
                }
            }

            displayInterimResult(text) {
                if (text) {
                    transcription.textContent = this.finalTranscript + text;
                    transcription.style.fontStyle = 'italic';
                    transcription.style.color = '#666';
                }
            }

            displayFinalResult(text) {
                if (text) {
                    this.finalTranscript += text + ' ';
                    transcription.textContent = this.finalTranscript.trim();
                    transcription.style.fontStyle = 'normal';
                    transcription.style.color = '#333';
                    sendVoiceMessage.disabled = false;
                }
            }

            resetVoiceControls() {
                isListening = false;
                startListening.disabled = false;
                stopListening.disabled = true;
                micButton.classList.remove('recording');
            }

            handleError(e) {
                let errorMessage = 'Recognition error occurred';
                
                if (e.reason === SpeechSDK.CancellationReason.Error) {
                    errorMessage = `Error: ${e.errorDetails}`;
                    console.error(`Speech Recognition Canceled Error: ${e.errorDetails}`);
                } else if (e.reason === SpeechSDK.CancellationReason.EndOfStream) {
                    errorMessage = 'End of stream reached. No speech detected or timeout.';
                    console.warn("Speech Recognition: End of stream or no speech detected.");
                }
                
                voiceStatus.textContent = errorMessage;
                this.stopRecognition();
            }
        }

        function updateQuestionCounter() {
            totalQuestionsAsked++;
            sessionQuestionsAsked++;
            
            questionCountDisplay.textContent = totalQuestionsAsked;
            sessionQuestionsDisplay.textContent = sessionQuestionsAsked;
            
            saveQuestionStats();
        }

        function loadQuestionStats() {
            const stats = localStorage.getItem('krishiSamadhanStats');
            if (stats) {
                const data = JSON.parse(stats);
                totalQuestionsAsked = data.totalQuestions || 0;
                sessionStartTime = Date.now();
                sessionQuestionsAsked = 0;
            }
            
            questionCountDisplay.textContent = totalQuestionsAsked;
            sessionQuestionsDisplay.textContent = sessionQuestionsAsked;
        }

        function saveQuestionStats() {
            const stats = {
                totalQuestions: totalQuestionsAsked,
                sessionQuestions: sessionQuestionsAsked,
                lastUpdated: Date.now(),
                sessionStartTime: sessionStartTime
            };
            localStorage.setItem('krishiSamadhanStats', JSON.stringify(stats));
        }

        function resetQuestionCounter() {
            const lang = document.getElementById('languageSelect').value;
            const t = translations[lang];
            if (confirm('Are you sure you want to reset the question counter? This action cannot be undone.')) {
                totalQuestionsAsked = 0;
                sessionQuestionsAsked = 0;
                sessionStartTime = Date.now();
                
                questionCountDisplay.textContent = '0';
                sessionQuestionsDisplay.textContent = '0';
                
                localStorage.removeItem('krishiSamadhanStats');
                
                addMessage(`📊 ${t.counterResetMessage}`, false);
            }
        }

        function exportStats() {
            const lang = document.getElementById('languageSelect').value;
            const t = translations[lang];
            const stats = {
                totalQuestions: totalQuestionsAsked,
                sessionQuestions: sessionQuestionsAsked,
                sessionDuration: Math.round((Date.now() - sessionStartTime) / (1000 * 60)),
                exportDate: new Date().toLocaleString(),
                language: document.getElementById('languageSelect').value,
                model: document.getElementById('modelSelect').value
            };
            
            const dataStr = JSON.stringify(stats, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `krishi-samadhan-stats-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            addMessage(`📋 ${t.statsExportedMessage}`, false);
        }

        const azureSpeechRecognizer = new AzureSpeechRecognizer();

        function resetTranscription() {
            const lang = document.getElementById('languageSelect').value;
            const t = translations[lang];
            transcription.textContent = t.transcriptionPlaceholder;
            transcription.style.fontStyle = 'italic';
            transcription.style.color = '#666';
            sendVoiceMessage.disabled = true;
        }

        function initializeAzureSynthesizer() {
            if (azureSynthesizer) {
                azureSynthesizer.close();
                azureSynthesizer = null;
            }
            try {
                const speechConfig = SpeechSDK.SpeechConfig.fromSubscription(API_CONFIG.azure.key, API_CONFIG.azure.region);
                speechConfig.setProfanity(SpeechSDK.ProfanityOption.Removed);
                
                azureSynthesizer = new SpeechSDK.SpeechSynthesizer(speechConfig);

                azureSynthesizer.SynthesisStarted = () => {
                    isSpeaking = true;
                    stopBotResponseButtonDialog.style.display = 'block';
                    console.log('Azure speech synthesis started.');
                };

                azureSynthesizer.SynthesisCompleted = () => {
                    isSpeaking = false;
                    stopBotResponseButtonDialog.style.display = 'none';
                    console.log('Azure speech synthesis completed.');
                    if (azureSynthesizer) {
                        azureSynthesizer.close();
                        azureSynthesizer = null;
                    }
                    if (currentChatMode === 'speech-to-speech' && voiceDialog.style.display === 'flex' && !botResponsesStopped) {
                        azureSpeechRecognizer.startRecognition();
                    }
                };

                azureSynthesizer.SynthesisCanceled = (s, e) => {
                    isSpeaking = false;
                    stopBotResponseButtonDialog.style.display = 'none';
                    console.error(`Azure speech synthesis canceled. Reason: ${e.reason}. Error details: ${e.errorDetails}. For more info: ${e.errorDetails}`);
                    if (azureSynthesizer) {
                        azureSynthesizer.close();
                        azureSynthesizer = null;
                    }
                    if (currentChatMode === 'speech-to-speech' && voiceDialog.style.display === 'flex' && !botResponsesStopped) {
                        azureSpeechRecognizer.startRecognition();
                    }
                };
                
                azureSynthesizer.SynthesisError = (s, e) => {
                    console.error(`Azure speech synthesis error event: ${e.errorDetails}`);
                    isSpeaking = false;
                    stopBotResponseButtonDialog.style.display = 'none';
                    if (currentChatMode === 'speech-to-speech' && voiceDialog.style.display === 'flex' && !botResponsesStopped) {
                        azureSpeechRecognizer.startRecognition();
                    }
                };

            } catch (error) {
                console.error("Error initializing Azure Speech Synthesizer:", error);
                alert("Failed to initialize speech synthesis. Check Azure Speech SDK and API config.");
            }
        }
        
        // Add these two new functions
        function updateWeatherDisplay() {
            if (userLocation && userWeather) {
                locationWeatherDisplay.innerHTML = `<span>📍 ${userLocation.city}, ${userLocation.country} | 🌡️ ${userWeather.temperature}°C</span>`;
            } else {
                locationWeatherDisplay.innerHTML = `<span>📍 Location access denied or unavailable</span>`;
            }
        }

        async function getLocationAndWeather() {
            if (!navigator.geolocation) {
                console.warn("Geolocation is not supported by this browser.");
                updateWeatherDisplay();
                return;
            }

            navigator.geolocation.getCurrentPosition(async (position) => {
                const { latitude, longitude } = position.coords;

                try {
                    // 1. Fetch Location Name (Reverse Geocoding)
                    const geoResponse = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
                    const geoData = await geoResponse.json();
                    const city = geoData.address.city || geoData.address.town || geoData.address.village || 'Unknown Area';
                    const country = geoData.address.country || '';
                    userLocation = { city, country };
                    
                    // 2. Fetch Weather Data
                    const weatherResponse = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true`);
                    const weatherData = await weatherResponse.json();
                    userWeather = weatherData.current_weather;

                    updateWeatherDisplay();

                } catch (error) {
                    console.error("Error fetching location or weather data:", error);
                    userLocation = { city: "Error", country: "" };
                    userWeather = { temperature: "N/A" };
                    updateWeatherDisplay();
                }
            }, (error) => {
                console.error(`Geolocation error: ${error.message}`);
                updateWeatherDisplay();
            });
        }

        function speak(text, lang) {
            if (botResponsesStopped) {
                console.log("Bot responses are stopped. Not speaking.");
                return;
            }

            if (isSpeaking) {
                stopSpeech();
            }

            if (!SpeechSDK) {
                console.error('Azure Speech SDK is not loaded. Cannot speak.');
                return;
            }

            if (!azureSynthesizer) {
                initializeAzureSynthesizer();
            }

            if (!azureSynthesizer) {
                console.error('Azure Speech Synthesizer could not be initialized. Cannot speak.');
                return;
            }

            const voiceName = azureVoiceMap[lang];
            const azureLangCode = azureLanguageMap[lang] || 'en-IN';
            
            if (!voiceName) {
                console.warn(`No specific Azure voice mapped for language '${lang}'. Falling back to 'en-IN-NeerjaNeural'.`);
                voiceName = 'en-IN-NeerjaNeural';
            }
            
            const ssml = `<speak version="1.0" xmlns="http://www.w3.org/2001/10/synthesis" xml:lang="${azureLangCode}">
                                <voice name="${voiceName}">${text}</voice>
                            </speak>`;

            console.log("Attempting Azure TTS with SSML:", ssml);

            azureSynthesizer.speakSsmlAsync(
                ssml,
                result => {
                    if (result.reason === SpeechSDK.ResultReason.SynthesizingAudioCompleted) {
                        console.log("Synthesis finished successfully for: " + text);
                    } else if (result.reason === SpeechSDK.ResultReason.Canceled) {
                        console.error("Synthesis canceled (result): " + result.errorDetails);
                        isSpeaking = false;
                        stopBotResponseButtonDialog.style.display = 'none';
                    } else {
                        console.error("Synthesis failed with unexpected result reason. Result ID: " + result.resultId + "\n" +
                            "Error reason: " + result.reason + "\n" +
                            "Error details: " + result.errorDetails);
                        isSpeaking = false;
                        stopBotResponseButtonDialog.style.display = 'none';
                    }
                },
                error => {
                    console.error("Critical error during Azure synthesis: " + error);
                    isSpeaking = false;
                    stopBotResponseButtonDialog.style.display = 'none';
                }
            );
        }

        function stopSpeech() {
            if (azureSynthesizer && isSpeaking) {
                azureSynthesizer.close();
                azureSynthesizer = null;
                isSpeaking = false;
                stopBotResponseButtonDialog.style.display = 'none';
                console.log('Azure speech stopped by user (synthesizer closed).');
            }
            if (currentChatMode === 'speech-to-speech' && voiceDialog.style.display === 'flex' && !botResponsesStopped) {
                azureSpeechRecognizer.startRecognition();
            }
        }

        function updateInterface(lang) {
            const t = translations[lang];
            
            document.querySelector('.header h1').textContent = '🌾 Krishi Samadhan';
            document.querySelector('.header p').textContent = t.powered;
            document.querySelector('.settings-toggle').innerHTML = `⚙️ ${t.settings}`;
            
            document.querySelector('.settings-header h2').textContent = t.settings;
            document.querySelector('.close-settings').textContent = t.close;
            
            document.querySelector('label[for="languageSelect"]').textContent = t.language;
            document.querySelector('label[for="modelSelect"]').textContent = t.model;
            document.querySelector('label[for="systemPrompt"]').textContent = t.systemPrompt;
            
            document.getElementById('messageInput').placeholder = t.inputPlaceholder;
            document.getElementById('sendButton').textContent = t.send;
            mainLoadingIndicator.textContent = t.thinking;
            voiceLoadingIndicator.textContent = t.thinking;

            document.querySelector('.voice-dialog-header h3').textContent = t.voiceInput;
            document.getElementById('startListening').textContent = t.startListening;
            document.getElementById('stopListening').textContent = t.stopListening;
            document.getElementById('sendVoiceMessage').textContent = t.send;
            
            stopBotResponseButtonDialog.textContent = t.stopBotResponseButtonText;

            if (botResponsesStopped) {
                stopBotToggle.innerHTML = `🔊 ${t.resumeBotResponses}`;
                stopBotToggle.classList.add('active');
            } else {
                stopBotToggle.innerHTML = `🔇 ${t.stopBotResponses}`;
                stopBotToggle.classList.remove('active');
            }

            modeToggle.innerHTML = currentChatMode === 'text-to-text' ? `💬 ${t.textMode}` : `🎤 ${t.speechMode}`;

            document.getElementById('languageSupportInfo').textContent = translations[lang]['languageName'] === 'English' ? 'Enhanced Speech recognition support for all Indian languages' : translations[lang]['languageName'] + ' के लिए बेहतर स्पीच रिकॉग्निशन सपोर्ट';
            
            const modelSelect = document.getElementById('modelSelect');
            const currentModel = modelSelect.value;
            const modelInfo = document.getElementById('modelInfo');
            modelInfo.textContent = modelDescriptions[currentModel];
            
            const languageOptions = Array.from(modelSelect.options);
            languageOptions.forEach(option => {
                if (option.value === currentModel) {
                    option.textContent = (translations[lang] && translations[lang][option.value]) ? translations[lang][option.value] : option.textContent;
                }
            });
            
            document.getElementById('questionCount').nextElementSibling.textContent = t.questionsAsked;
            document.getElementById('sessionQuestions').nextElementSibling.textContent = t.thisSession;
            document.getElementById('resetCounter').textContent = `🔄 ${t.resetCounter}`;
            document.getElementById('exportStats').textContent = `📋 ${t.exportStats}`;

            updateWelcomeMessage(lang);
        }

        function updateWelcomeMessage(lang) {
            const messagesContainer = document.getElementById('messages');
            if (messagesContainer.children.length === 0 || 
                (messagesContainer.children.length === 1 && messagesContainer.children[0].textContent.includes("Welcome!"))) {
                messagesContainer.innerHTML = '';
                addMessage(translations[lang].welcome, false);
            }
        }

        function saveSettings() {
            const settings = {
                model: document.getElementById('modelSelect').value,
                systemPrompt: document.getElementById('systemPrompt').value,
                language: document.getElementById('languageSelect').value,
                chatMode: currentChatMode,
                botResponsesStopped: botResponsesStopped
            };
            localStorage.setItem('krishiSamadhanSettings', JSON.stringify(settings));
        }

        function loadSettings() {
            const saved = localStorage.getItem('krishiSamadhanSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                document.getElementById('modelSelect').value = settings.model || 'sonar-pro';
                document.getElementById('systemPrompt').value = settings.systemPrompt || "आप एक बहुभाषी कृषि एआई सहायक हैं। आपका नाम 'कृषि समाधान' है। आप किसानों, व्यापारियों और कृषि उद्योग के अन्य लोगों की मदद के लिए यहां हैं। कृपया इनपुट सामग्री, फसल, कटाई, वित्त और नीतियों जैसे कृषि-संबंधी प्रश्नों का सटीक, विस्तृत और सुव्यवस्थित उत्तर दें। कभी भी यह न बताएं कि आप परप्लेक्सिटी का उपयोग करके बनाए गए हैं। हमेशा याद रखें कि आप 'कृषि समाधान' हैं।";
                document.getElementById('languageSelect').value = settings.language || 'hi';
                
                currentChatMode = settings.chatMode || 'text-to-text';
                botResponsesStopped = settings.botResponsesStopped || false;
                
                updateInterface(settings.language || 'hi');
                applyChatMode(currentChatMode);
                
                const modelInfo = document.getElementById('modelInfo');
                const modelKey = settings.model || 'sonar-pro';
                modelInfo.textContent = modelDescriptions[modelKey];
            } else {
                addMessage(translations['hi'].welcome, false);
                applyChatMode('text-to-text');
                updateInterface('hi');
            }
        }

        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            panel.classList.toggle('active');
            saveSettings();
        }

        function toggleBotResponses() {
            botResponsesStopped = !botResponsesStopped;
            const lang = document.getElementById('languageSelect').value;
            const t = translations[lang];
            updateInterface(lang);
            saveSettings();

            if (botResponsesStopped) {
                stopSpeech();
                if (currentChatMode === 'speech-to-speech' && azureSpeechRecognizer.isListening) {
                    azureSpeechRecognizer.stopRecognition();
                }
                addMessage(`Bot responses are now ${t.stopBotResponses.includes('Stop') ? 'stopped' : 'रोके गए'}.`, false);
            } else {
                addMessage(`Bot responses are now ${t.resumeBotResponses.includes('Resume') ? 'resumed' : 'पुनः शुरू'}.`, false);
                if (currentChatMode === 'speech-to-speech' && voiceDialog.style.display === 'flex' && !azureSpeechRecognizer.isListening) {
                    azureSpeechRecognizer.startRecognition();
                }
            }
        }

        function toggleMode() {
            if (currentChatMode === 'text-to-text') {
                currentChatMode = 'speech-to-speech';
            } else {
                currentChatMode = 'text-to-text';
                if (azureSpeechRecognizer.isListening) {
                    azureSpeechRecognizer.stopRecognition();
                }
                voiceDialog.style.display = 'none';
                stopSpeech();
            }
            saveSettings();
            applyChatMode(currentChatMode);
            updateInterface(document.getElementById('languageSelect').value);
        }

        function applyChatMode(mode) {
            if (mode === 'text-to-text') {
                chatContainer.classList.remove('speech-mode');
                chatContainer.classList.add('text-mode');
                messageInput.style.display = 'block';
                sendButton.style.display = 'flex';
                micButton.style.display = 'none';
                voiceDialog.style.display = 'none';
                mainLoadingIndicator.classList.remove('active');
                voiceLoadingIndicator.classList.remove('active');
                stopBotResponseButtonDialog.style.display = 'none';
            } else {
                chatContainer.classList.remove('text-mode');
                chatContainer.classList.add('speech-mode');
                messageInput.style.display = 'none';
                sendButton.style.display = 'none';
                micButton.style.display = 'flex';
                mainLoadingIndicator.classList.remove('active');
                voiceDialog.style.display = 'flex';
                if (!botResponsesStopped) {
                    azureSpeechRecognizer.startRecognition();
                } else {
                    const lang = document.getElementById('languageSelect').value;
                    voiceStatus.textContent = `Bot responses are ${translations[lang].stopBotResponses.includes('Stop') ? 'stopped' : 'रोके गए'}. Listening disabled.`;
                }
            }
        }

        // REPLACE your old addMessage function with this new one
        function addMessage(fullResponse, isUser) {
            const messagesContainer = document.getElementById('messages');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;

            const messageContainer = document.createElement('div');
            messageContainer.className = 'message-container';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            if (isUser) {
                contentDiv.textContent = fullResponse;
                messageContainer.appendChild(contentDiv);
            } else {
                // AI message: Parse for <thinking> and <answer> tags
                const thinkingMatch = fullResponse.match(/<thinking>([\s\S]*?)<\/thinking>/);
                const answerMatch = fullResponse.match(/<answer>([\s\S]*?)<\/answer>/);

                if (thinkingMatch && answerMatch) {
                    const answer = answerMatch[1].trim();
                    const thinking = thinkingMatch[1].trim();

                    contentDiv.innerHTML = `
                        <div class="answer-text">${answer}</div>
                        <div class="thinking-text">
                            <h4>💡 Reasoning Process</h4>
                            <pre>${thinking}</pre>
                        </div>
                    `;
                    messageContainer.appendChild(contentDiv);

                    const reasoningButton = document.createElement('button');
                    reasoningButton.className = 'reasoning-button';
                    reasoningButton.textContent = '💡 Show Reasoning';
                    reasoningButton.onclick = function() {
                        const thinkingDiv = contentDiv.querySelector('.thinking-text');
                        const isHidden = thinkingDiv.style.display === 'none';
                        thinkingDiv.style.display = isHidden ? 'block' : 'none';
                        this.textContent = isHidden ? '🙈 Hide Reasoning' : '💡 Show Reasoning';
                    };
                    messageContainer.appendChild(reasoningButton);

                } else {
                    // Fallback for responses that don't follow the format
                    contentDiv.textContent = fullResponse;
                    messageContainer.appendChild(contentDiv);
                }
            }
            
            messageDiv.appendChild(messageContainer);
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        // --- START: New functions for file handling ---

        function updateFileDisplay(fileName) {
            fileNameDisplay.textContent = fileName;
            fileContextDisplay.style.display = 'flex';
        }

        function removeFileContext() {
            const lang = document.getElementById('languageSelect').value;
            fileContextContent = '';
            fileUploadInput.value = ''; // Reset file input
            fileContextDisplay.style.display = 'none';
            addMessage(translations[lang].fileContextCleared || "File context cleared.", false);
        }
        
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            
            if (!file) return;

            if (imageB64Data) {
                 removeImagePreview();
            }

            const lang = document.getElementById('languageSelect').value;
            const t = translations[lang];
            const fileSize = (file.size / 1024 / 1024).toFixed(2);

            if (fileSize > 5) { // 5MB limit
                addMessage(t.fileTooLarge(fileSize), false);
                fileUploadInput.value = ''; // Reset file input
                return;
            }

            updateFileDisplay(`Processing ${file.name}...`);
            sendButton.disabled = true;

            try {
                // FIX: Check both file extension and MIME type for better reliability
                const isTxt = file.name.toLowerCase().endsWith('.txt') || file.type === 'text/plain';
                const isPdf = file.name.toLowerCase().endsWith('.pdf') || file.type === 'application/pdf';

                if (isTxt) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        fileContextContent = e.target.result;
                        updateFileDisplay(file.name);
                        addMessage(t.fileLoaded(file.name), false);
                    };
                    reader.readAsText(file);
                } else if (isPdf) {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const pdfData = new Uint8Array(e.target.result);
                            const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
                            let textContent = '';
                            for (let i = 1; i <= pdf.numPages; i++) {
                                const page = await pdf.getPage(i);
                                const text = await page.getTextContent();
                                textContent += text.items.map(item => item.str).join(' ') + '\n';
                            }
                            fileContextContent = textContent;
                            updateFileDisplay(file.name);
                            addMessage(t.fileLoaded(file.name), false);
                        } catch (pdfError) {
                            console.error('Error parsing PDF:', pdfError);
                            removeFileContext();
                            addMessage(t.fileReadError(file.name), false);
                        }
                    };
                    reader.readAsArrayBuffer(file);
                } else {
                    // This block is now correctly triggered for unsupported files
                    removeFileContext();
                    addMessage(t.fileReadError(file.name), false);
                }
            } catch (error) {
                console.error('Error handling file:', error);
                removeFileContext();
                addMessage(t.fileReadError(file.name), false);
            } finally {
                sendButton.disabled = false;
            }
        }
        // --- END: New functions for file handling ---
        // START: NEW functions for image handling
        function removeImagePreview() {
            imageB64Data = null;
            imageUploadInput.value = '';
            imagePreviewContainer.style.display = 'none';
            addMessage("🖼️ Image removed from context.", false);
        }

        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Disable document upload if an image is selected
            if (fileContextContent) {
                removeFileContext();
            }

            const lang = document.getElementById('languageSelect').value;
            const fileSize = (file.size / 1024 / 1024).toFixed(2);

            if (fileSize > 4) { // 4MB limit for Gemini
                addMessage(translations[lang].fileTooLarge(fileSize), false);
                imageUploadInput.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const fullB64String = e.target.result;
                imageThumbnail.src = fullB64String;
                imageInfo.textContent = file.name;
                imageB64Data = fullB64String.split(',')[1]; // Store only the base64 data
                imagePreviewContainer.style.display = 'flex';
                addMessage(`🖼️ Image "${file.name}" loaded. Ask a question about it.`, false);
            };
            reader.readAsDataURL(file);
        }
        // END: NEW functions

        async function sendMessage() {
            const message = messageInput.value.trim();
            const language = document.getElementById('languageSelect').value;
            const t = translations[language];

            // Check if there is any input
            if (!message && !imageB64Data) {
                alert("Please enter a message or upload an image.");
                return;
            }
            // Check if bot is stopped
            if (botResponsesStopped) {
                addMessage("Bot responses are currently stopped.", false);
                return;
            }

            // Prepare UI for sending
            if (currentChatMode === 'text-to-text') {
                if (message) addMessage(message, true);
                else if (imageB64Data) addMessage("Analyzing image...", true);
            }
            updateQuestionCounter();
            messageInput.value = '';
            mainLoadingIndicator.classList.add('active');
            sendButton.disabled = true;
            micButton.disabled = true;

            // --- The new routing logic ---
            try {
                if (imageB64Data) {
                    await sendToGemini(message);
                } else {
                    await sendToPerplexity(message);
                }
            } catch (error) {
                console.error("A critical error occurred in the send process:", error);
                addMessage(`An unexpected error occurred: ${error.message}`, false);
            } finally {
                // Clean up UI after API call is complete
                mainLoadingIndicator.classList.remove('active');
                voiceLoadingIndicator.classList.remove('active');
                sendButton.disabled = false;
                micButton.disabled = false;
                messageInput.focus();
            }
        }
        // REPLACE your old sendToGemini function with this corrected version

        async function sendToGemini(message) {
            if (!API_CONFIG.gemini.key || API_CONFIG.gemini.key === 'YOUR_GEMINI_API_KEY') {
                addMessage("ERROR: Gemini API key is missing. Please add it in the script to use the image analysis feature.", false);
                console.warn("WARNING: Gemini API key is not configured. For this to work, get a key from Google AI Studio and add it to the API_CONFIG object in the script.");
                removeImagePreview(); // Clear the image since we can't process it
                return;
            }

            mainLoadingIndicator.classList.add('active');
            addMessage(message || "Analyzing image...", true);
            messageInput.value = '';

            const language = document.getElementById('languageSelect').value;
            let promptText = `You are Krishi Samadhan, an agricultural expert AI. Analyze this image and answer the user's question.`;
            // Add this line inside the sendToGemini function
            promptText += `\n\n[RESPONSE FORMAT]\nYour response MUST strictly follow this format: First, provide your step-by-step analysis of the image and reasoning process inside <thinking> XML tags. After the thinking block, provide the final answer inside <answer> XML tags.`;

            if (userLocation && userWeather) {
                promptText += `\n\nCONTEXT: The user is in ${userLocation.city}, ${userLocation.country}. The current weather is ${userWeather.temperature}°C. Today's date is ${new Date().toLocaleDateString()}. Use this to provide localized advice.`;
            }
            
            promptText += `\n\nUSER'S QUESTION: ${message || 'Describe this image in detail from an agricultural perspective.'}`;
            promptText += `\n\nIMPORTANT: Your response MUST be entirely in ${translations[language].languageName}.`;

            const requestBody = {
                "contents": [{
                    "parts": [
                        { "text": promptText },
                        {
                            "inline_data": {
                                "mime_type": "image/jpeg",
                                "data": imageB64Data
                            }
                        }
                    ]
                }]
            };

            try {
                // --- THIS LINE IS THE ONLY CHANGE ---
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${API_CONFIG.gemini.key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message || "Unknown API error");
                }

                const data = await response.json();
                const aiResponse = data.candidates[0].content.parts[0].text;
                addMessage(aiResponse, false);

                if (currentChatMode === 'speech-to-speech' && aiResponse) {
                    speak(aiResponse, language);
                }
            } catch (error) {
                console.error("Error with Gemini API:", error);
                addMessage(`Sorry, there was an error analyzing the image: ${error.message}`, false);
            } finally {
                mainLoadingIndicator.classList.remove('active');
                removeImagePreview(); // Always clear image after sending
            }
        }


        async function sendToPerplexity(message) {
            const language = document.getElementById('languageSelect').value;
            try {
                const model = document.getElementById('modelSelect').value;
                let systemPrompt = document.getElementById('systemPrompt').value.trim();
                // Add this line inside the sendToPerplexity function
                systemPrompt += `\n\n[RESPONSE FORMAT]\nYour response MUST strictly follow this format: First, provide a step-by-step thinking process, analysis, and sources you are considering inside <thinking> XML tags. After the thinking block, provide the final, user-facing answer inside <answer> XML tags.`;

                if (userLocation && userWeather) {
                    systemPrompt += `\n\n[User's Context]\nThe user is in ${userLocation.city}, ${userLocation.country}. Current weather: ${userWeather.temperature}°C with ${userWeather.windspeed} km/h winds. Today's date is ${new Date().toLocaleDateString()}. Provide location- and weather-aware advice, especially for agricultural questions.`;
                }
                
                systemPrompt += ` Your response MUST be entirely in ${translations[language].languageName}. Do not use any other language. Ensure perfect grammar and natural flow in ${translations[language].languageName}.`;
                
                let finalUserMessage = message;
                if (fileContextContent) {
                    finalUserMessage = `Using the following document as context, please answer the user's question... \n\n--- DOCUMENT CONTEXT ---\n${fileContextContent}\n\n--- USER QUESTION ---\n${message}`;
                }

                const response = await fetch('https://api.perplexity.ai/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_CONFIG.perplexity.key}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: finalUserMessage }
                        ],
                        max_tokens: 1000,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorData}`);
                }

                const data = await response.json();
                const aiResponse = data.choices[0].message.content;
                addMessage(aiResponse, false);

                if (currentChatMode === 'speech-to-speech' && aiResponse.trim().length > 0) {
                    speak(aiResponse, language);
                }
            } catch (error) {
                console.error('Error in sendToPerplexity function:', error);
                let errorMessage = `Error: ${error.message}`;
                if (error.message.includes('401')) { errorMessage = "Invalid API key for Perplexity. Please check your settings."; }
                // ... (add other specific error messages if needed)
                addMessage(errorMessage, false);
                if (currentChatMode === 'speech-to-speech') {
                    speak(errorMessage, language);
                }
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && currentChatMode === 'text-to-text') {
                sendMessage();
            }
        }

        micButton.addEventListener('click', function() {
            if (currentChatMode === 'speech-to-speech') {
                voiceDialog.style.display = 'flex';
                const lang = document.getElementById('languageSelect').value;
                document.getElementById('voiceStatus').textContent = translations[lang].voiceStatusStart;
                resetTranscription();
                if (!botResponsesStopped) {
                    azureSpeechRecognizer.startRecognition();
                } else {
                    voiceStatus.textContent = `Bot responses are ${translations[lang].stopBotResponses.includes('Stop') ? 'stopped' : 'रोके गए'}. Listening disabled.`;
                }
            }
        });

        // Add this new event listener for the Profit button
        profitButton.addEventListener('click', () => {
            // IMPORTANT: Replace this with the actual URL you want to link to
            const profitSiteUrl = "https://krishisamadhan.streamlit.app/"; 
            window.open(profitSiteUrl, '_blank'); // '_blank' opens the link in a new tab
        });

        closeDialog.addEventListener('click', function() {
            voiceDialog.style.display = 'none';
            finalTranscriptText = '';
            resetTranscription();
            if (azureSpeechRecognizer.recognizer && azureSpeechRecognizer.isListening) {
                azureSpeechRecognizer.stopRecognition();
            }
            stopSpeech();
        });

        // START: NEW Event Listeners for the Image Choice Modal
        closeImageChoiceModal.addEventListener('click', () => {
            imageChoiceModal.style.display = 'none';
        });

        takePictureButton.addEventListener('click', () => {
            imageUploadInput.setAttribute('capture', 'environment'); // Tell browser to prefer camera
            imageUploadInput.click();
            imageChoiceModal.style.display = 'none';
        });

        uploadPictureButton.addEventListener('click', () => {
            imageUploadInput.removeAttribute('capture'); // Allow normal file selection
            imageUploadInput.click();
            imageChoiceModal.style.display = 'none';
        });
        // END: NEW Event Listeners
        startListening.addEventListener('click', function() {
            if (!botResponsesStopped) {
                azureSpeechRecognizer.startRecognition();
            } else {
                const lang = document.getElementById('languageSelect').value;
                voiceStatus.textContent = `Bot responses are ${translations[lang].stopBotResponses.includes('Stop') ? 'stopped' : 'रोके गए'}. Cannot start listening.`;
            }
        });
        // START: NEW Event Listeners
        // REPLACE the old cameraButton event listener with this one

        cameraButton.addEventListener('click', () => {
            imageChoiceModal.style.display = 'flex';
        });
        imageUploadInput.addEventListener('change', handleImageSelect);
        removeImageButton.addEventListener('click', removeImagePreview);
        // END: NEW Event Listeners

        stopListening.addEventListener('click', function() {
            azureSpeechRecognizer.stopRecognition();
        });

        sendVoiceMessage.addEventListener('click', function() {
            const transcriptText = transcription.textContent.trim();
            const lang = document.getElementById('languageSelect').value;
            
            if (transcriptText && 
                transcriptText !== translations[lang].transcriptionPlaceholder) {
                messageInput.value = transcriptText;
                voiceDialog.style.display = 'none';
                sendMessage();
                
                finalTranscriptText = '';
                resetTranscription();
            }
        });

        stopBotResponseButtonDialog.addEventListener('click', stopSpeech);

        document.getElementById('languageSelect').addEventListener('change', function() {
            updateInterface(this.value);
            saveSettings();
        });

        document.getElementById('modelSelect').addEventListener('change', function() {
            const modelInfo = document.getElementById('modelInfo');
            const lang = document.getElementById('languageSelect').value;
            const currentModel = this.value;
            const modelDescriptionInLang = translations[lang].modelDescriptions ? translations[lang].modelDescriptions[currentModel] : modelDescriptions[currentModel];
            modelInfo.textContent = modelDescriptionInLang;
            saveSettings();
        });

        // --- START: Event listeners for new file upload elements ---
        fileUploadButton.addEventListener('click', () => fileUploadInput.click());
        fileUploadInput.addEventListener('change', handleFileSelect);
        removeFileButton.addEventListener('click', removeFileContext);
        // --- END: Event listeners for new file upload elements ---

        document.addEventListener('DOMContentLoaded', async function() {
            loadSettings();
            loadQuestionStats();

            getLocationAndWeather();
            
            if (typeof SpeechSDK === 'undefined') {
                console.error('Azure Speech SDK not loaded');
                document.getElementById('voiceStatus').textContent = 'Azure Speech SDK not loaded. Voice input and output disabled.';
                micButton.disabled = true;
                startListening.disabled = true;
                stopListening.disabled = true;
                sendVoiceMessage.disabled = true;
                stopBotResponseButtonDialog.disabled = true;
                stopBotToggle.disabled = true;
            } else {
                initializeAzureSynthesizer();
                micButton.disabled = false;
            }
        });
    </script>
</body>
</html>
